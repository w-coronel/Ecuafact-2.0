@using Ecuafact.Web.Domain.Entities
@model ReferralGuideRequestModel
@{
    if (Model.Id > 0)
    {
        ViewBag.Title = "Modificar Guia Remisión";
    }
    else
    {
        ViewBag.Title = "Crear Guia Remisión";
    }

    ViewBag.ParentTitle = "Emitidos";

    this.PageOptions(options =>
    {
        options.Select2 = true;
        options.DataTables = true;
        options.DatePicker = true;

    });


    var emisorActual = SessionInfo.Issuer;
    var tiposDocumento = SessionInfo.Catalog.DocumentTypes;
    var tiposIdentidad = SessionInfo.Catalog.IdentificationTypes;
    var drivers = new List<ContributorDto>();
    var recipients = new List<ContributorDto>();
    var docList = new List<SelectListItem>();

    if (Model.DriverId > 0)
    {
        drivers.Add(Model.ToDriver());
    }
    var driverList = drivers.Select(x => new SelectListItem { Text = string.Format("{0} - {1}", x.Identification, x.BussinesName), Value = x.Id.ToString() }).ToList();

    if (Model.RecipientId > 0)
    {
        recipients.Add(Model.ToRecipient());
    }
    var recipientList = recipients.Select(x => new SelectListItem { Text = string.Format("{0} - {1}", x.Identification, x.BussinesName), Value = x.Id.ToString() }).ToList();

    if (!string.IsNullOrWhiteSpace(Model.ReferenceDocumentNumber))
    {
        docList = new List<SelectListItem>()
        {
                new SelectListItem(){
                    Text = $"FACTURA {Model.ReferenceDocumentNumber} {Model.ReferenceDocumentDate} | {Model.Identification} {Model.ContributorName}",
                    Value = Model.ReferenceDocumentId.ToString()
                }
        };
    }
    else if (Model.Id > 0 && string.IsNullOrWhiteSpace(Model.ReferenceDocumentNumber) && Model.ReferenceDocumentId == null)
    {
        Model.ReferenceDocumentId = -1;
        docList = new List<SelectListItem>(){
            new SelectListItem(){
                Text = "Sin Documento Sustento",
                Value = "-1"
            }
        };
    }

    Model.DocumentTypeCode = "06"; // GUIA REMISIÓN
    Model.Currency = "DOLAR";

    var issuePoint = new List<SelectListItem>();
    var establishment = new List<SelectListItem>();
    if (SessionInfo.UserRole == Ecuafact.Web.Models.SecuritySessionRole.Cooperative)
    {
        SessionInfo.Issuer.Establishments.ForEach(s =>
        {
            var temp = s.IssuePoint.Where(d => d.CarrierRUC == SessionInfo.LoginInfo.UserInfo.Username)?.FirstOrDefault() ?? null;
            if (temp != null)
            {
                var _establishment = SessionInfo.Issuer.Establishments.Where(e => e.Id == temp.EstablishmentsId);
                establishment = _establishment.Select(x => new SelectListItem { Text = string.Format("{0} - {1}", x.Code, x.Address), Value = x.Code }).ToList();
                Model.EstablishmentCode = _establishment.FirstOrDefault().Code;
                Model.EstablishmentAddress = _establishment.FirstOrDefault().Address;
                issuePoint = new List<SelectListItem> { new SelectListItem { Text = $"{temp.CarrierRUC}-{temp.Name}", Value = temp.Code } };

                Model.AdditionalFields = new List<AdditionalFieldModel> {
                    new AdditionalFieldModel {LineNumber =1, Name="RUC TRANSPORTISTA", Value = temp.CarrierRUC },
                    new AdditionalFieldModel {LineNumber =2, Name="NOMBRE TRANSPORTISTA", Value = temp.Name },
                };
            }
        });
    }
    else
    {
        establishment = SessionInfo.Issuer.Establishments.Select(x => new SelectListItem { Text = string.Format("{0} - {1}", x.Code, x.Address), Value = x.Code }).ToList();
        if (Model.Id > 0)
        {
            issuePoint = SessionInfo.Issuer.Establishments.Where(s => s.Code == Model.EstablishmentCode).FirstOrDefault().IssuePoint.Select(x => new SelectListItem { Text = x.Code, Value = x.Code }).ToList();
        }
        if (establishment?.Count == 1)
        {
            Model.EstablishmentCode = establishment.First().Value;
            Model.EstablishmentAddress = SessionInfo.Issuer.Establishments.First().Address;
            issuePoint = SessionInfo.Issuer.Establishments.Where(s => s.Code == Model.EstablishmentCode).FirstOrDefault().IssuePoint.Select(x => new SelectListItem { Text = x.Code, Value = x.Code }).ToList();
        }
    }

}


@section styles{
    @Styles.Render("~/css/invoice")
}


@using (Html.BeginForm("SaveReferralGuideAsync", "GuiaRemision", FormMethod.Post, new { @class = "referralGuide-form" }))
{
    @Html.AntiForgeryToken()
    @Html.HiddenFor(model => model.Id)   
    @Html.HiddenFor(model => model.DocumentTypeCode)
    @Html.HiddenFor(model => model.Currency)
    @Html.HiddenFor(model => model.Status)
    @Html.HiddenFor(model => model.EstablishmentAddress)

    <div class="kt-invoice-1">
        <div class="kt-invoice__head" style="background-image: url(@Url.Content("~/assets/media/bg/300.jpg"));">
            <div class="kt-invoice__container">
                <div class="kt-invoice__brand">
                    <div class="kt-invoice__item">
                        <h1 class="kt-invoice__title">
                            GUIA DE REMISIÓN
                            @if (!string.IsNullOrEmpty(Model.DocumentNumber))
                            {
                                <small>No. @Model.DocumentNumber</small>
                            }
                        </h1>

                    </div>
                </div>

                <div class="kt-invoice__items">
                    <div class="kt-invoice__item col-sm-12">
                        <div class="row">
                            <div class="col-md-9 col-sm-12 col-xs-12">
                                <label class="kt-invoice__subtitle">
                                    Establecimiento:
                                </label>
                                <div class="kt-input-icon kt-input-icon--right">
                                    @Html.DropDownListFor(model => model.EstablishmentCode, new SelectList(establishment, "Value", "Text", Model.EstablishmentCode), "Seleccione establecimiento", new
                                    {
                                        @class = "form-control select-establishment",
                                        @aria_describedby = "addon-customer_select",
                                        @style = "width:100%"
                                    })
                                    @Html.ValidationMessageFor(model => model.EstablishmentCode, "")
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6 col-xs-12">
                                <label class="kt-invoice__subtitle">
                                    Punto de Emisión:
                                </label>
                                <div class="kt-input-icon kt-input-icon--right">
                                    @Html.DropDownListFor(model => model.IssuePointCode, new SelectList(issuePoint, "Value", "Text", Model.IssuePointCode), new { @class = "bs-dropdown circle-right input-sm input-inline form-control  filter-control select-issuePointCode" })

                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <div class="kt-invoice__items">
                    <div class="kt-invoice__item col-sm-10">
                        <div class="row">
                            <div class="col-md-11">

                                <label class="kt-invoice__subtitle">
                                    Documento:
                                </label>
                                <div class="kt-input-icon kt-input-icon--right">
                                    @Html.DropDownListFor(model => model.ReferenceDocumentId, new SelectList(docList, "Value", "Text", Model.ReferenceDocumentId), "Por favor seleccione un documento", new
                                    {
                                        @class = "form-control js-documentSelector",
                                        @aria_describedby = "addon-customer_select",
                                        @style = "width:100%"
                                    })                                   
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="kt-invoice__item col-sm-2">
                        <div class="row">
                            <div class="col-md-12">
                                <label class="kt-invoice__subtitle">Fecha Emisión</label>
                                <div class="kt-input-icon kt-input-icon--right " style=" max-width:150px;">
                                    @Html.TextBoxFor(model => model.IssuedOn, new
                                   {
                                       @class = "form-control input-readonly datepicker",
                                       @style = "max-width:100%;",
                                       @placeholder = "Fecha",
                                       @required = "",
                                       @data_date_end_date = "0d",
                                       @aria_describedby = "addon-fecha_documento",
                                       @readonly = "readonly"
                                   })
                                    @Html.ValidationMessageFor(model => model.IssuedOn, "")
                                    <span id="addon-fecha_documento" class="kt-input-icon__icon kt-input-icon__icon--right">
                                        <span> <i class="fa fa-calendar-alt"></i></span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="kt-invoice__items">
                    <div class="kt-invoice__item col-md-12 col-sm-12 col-xs-12">
                        <div class="row">
                            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                <h5 class="kt-invoice__subtitle">Datos del Comprobante de Venta</h5>
                                <label>Indique la información basica del documento que usted desea utilizar como respaldo del transporte : </label>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 col-sm-10 col-xs-12">
                                @Html.HiddenFor(model => model.ContributorId)
                                @Html.HiddenFor(model => model.Phone)
                                @Html.HiddenFor(model => model.Address)
                                @Html.HiddenFor(model => model.EmailAddresses)
                                <table class="border-0" style="width:100%;">                                   
                                    <tr>                                        
                                        <td style="text-align:left;padding-bottom:5px">
                                            <div class="col-md-12 col-sm-12 col-xs-12">
                                                <label class="kt-invoice__subtitle">
                                                    Tipo de Identificación:
                                                </label>
                                                <div class="kt-input-icon kt-input-icon--right">
                                                    @Html.DropDownListFor(model => model.IdentificationType, new SelectList(tiposIdentidad, "SriCode", "Name", Model.IdentificationType),  new { @class = "form-control", @required = "required" })
                                                </div>
                                            </div>
                                          
                                        </td>
                                    </tr>
                                    <tr>                                       
                                        <td style="text-align:left; padding-bottom: 5px">
                                            <div class="col-md-12 col-sm-12 col-xs-12">
                                                <label class="kt-invoice__subtitle">
                                                    No. Identificación:
                                                </label>
                                                <div class="kt-input-icon kt-input-icon--right">
                                                    @Html.TextBoxFor(model => model.Identification, new { @class = "form-control" })
                                                    @Html.ValidationMessageFor(model => model.Identification, "")
                                                </div>
                                            </div>                                              
                                        </td>
                                    </tr>
                                    <tr>                                       
                                        <td style="text-align:left; padding-bottom: 5px">
                                            <div class="col-md-12 col-sm-12 col-xs-12">
                                                <label class="kt-invoice__subtitle">
                                                    Nombre/Razón Social:
                                                </label>
                                                <div class="kt-input-icon kt-input-icon--right">
                                                    @Html.TextBoxFor(model => model.ContributorName, new { @class = "form-control" })
                                                    @Html.ValidationMessageFor(model => model.ContributorName, "")
                                                </div>
                                            </div>
                                        </td>
                                    </tr>

                                </table>
                            </div>

                            <div class="col-md-6 col-sm-10 col-xs-12">
                                <table class="border-0" style="width:100%;">
                                    <tr>                                        
                                        <td style="text-align:left; padding-bottom: 5px">
                                            <div class="col-md-12 col-sm-12 col-xs-12">
                                                <label class="kt-invoice__subtitle">
                                                    Tipo de Comprobante:
                                                </label>
                                                <div class="kt-input-icon kt-input-icon--right">
                                                    @Html.DropDownListFor(model => model.ReferenceDocumentCode, new SelectList(tiposDocumento, "SriCode", "Name", Model.ReferenceDocumentCode),
                                                      new
                                                           {
                                                          @class = "form-control m-b ref-tipo-comprobante",
                                                          @style = "width:100%; text-align:right;",
                                                          @required = ""
                                                      })
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>                                        
                                        <td style="text-align: left; padding-bottom: 5px">
                                            <div class="col-md-12 col-sm-12 col-xs-12">
                                                <label class="kt-invoice__subtitle">
                                                    Número de Comprobante:
                                                </label>
                                                <div class="kt-input-icon kt-input-icon--right">
                                                    @Html.EditorFor(model => model.ReferenceDocumentNumber, new { htmlAttributes = new {
                                                                                                                          @id = "ref_numero_comprobante",
                                                                                                                          @class = "form-control",
                                                                                                                          @placeholder = "000-000-000000000",
                                                                                                                          @style = "width:100%;border:none none solid none; text-align:right;",
                                                                                                                          @required = "",
                                                                                                                          @maxlength = "17"
                                                                                                                      }
                                                                                                                  })
                                                </div>
                                            </div>                                           
                                        </td>
                                    </tr>
                                    <tr>                                        
                                        <td style="text-align: left; padding-bottom: 5px">
                                            <div class="col-md-12 col-sm-12 col-xs-12">
                                                <label class="kt-invoice__subtitle">
                                                    Fecha del Documento:
                                                </label>
                                                <div class="kt-input-icon kt-input-icon--right">
                                                    @Html.EditorFor(model => model.ReferenceDocumentDate,
                                                                       new
                                                                            {
                                                                           htmlAttributes = new
                                                                           {
                                                                               @id = "ref_fecha_documento",
                                                                               @class = "form-control input-readonly",
                                                                               @placeholder = "Fecha del Documento",
                                                                               @style = "border:none none solid none;background-color:white; text-align:right;",
                                                                               @required = "",
                                                                               @readonly = ""
                                                                           }
                                                                       })
                                                </div>
                                            </div>                                           
                                        </td>
                                    </tr>
                                    <tr>                                        
                                        <td style="text-align: left; padding-bottom: 5px">
                                            <div class="col-md-12 col-sm-12 col-xs-12">
                                                <label class="kt-invoice__subtitle">
                                                    Número Autorización:
                                                </label>
                                                <div class="kt-input-icon kt-input-icon--right">
                                                    @Html.EditorFor(model => model.ReferenceDocumentAuth, new
                                                    {
                                                        htmlAttributes = new
                                                                            {
                                                                                @type = "number",
                                                                                @id = "ref_autorizacion_comprobante",
                                                                                @class = "form-control",
                                                                                @placeholder = "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
                                                                                @style = "width:100%;border:none none solid none; text-align:right;",
                                                                                @maxlength = 49,
                                                                                @required = ""
                                                                            }
                                                                        })
                                                </div>
                                            </div>
                                            
                                        </td>
                                    </tr>

                                </table>
                            </div>
                        </div>
                    </div>
                </div>   
                
                <div class="kt-invoice__items">
                    <div class="kt-invoice__item col-md-12 col-sm-12 col-xs-12">
                        <div class="row">
                            <div class="col-md-12 col-sm-12 col-xs-12">
                                <h5 class="kt-invoice__subtitle">Datos del Traslado</h5>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 col-sm-10 col-xs-12">
                                <table class="border-0" style="width:100%;">
                                    <tr>                                        
                                        <td style="text-align:left;padding-bottom:5px">
                                            <div class="col-md-12 col-sm-12 col-xs-12">
                                                <label class="kt-invoice__subtitle">
                                                    Número de Declaración Aduanera:
                                                </label>
                                                <div class="kt-input-icon kt-input-icon--right">
                                                    @Html.EditorFor(model => model.DAU, new
                                                       {
                                                           htmlAttributes = new
                                                           {

                                                                          @class = "form-control m-b",
                                                                          @style = "width:100%;",
                                                                          @placeholder = "Documento DAU # ",
                                                                          @required = ""
                                                                      }
                                                                  })
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>                                        
                                        <td style="text-align: left; padding-bottom: 5px">
                                            <div class="col-md-12 col-sm-12 col-xs-12">
                                                <label class="kt-invoice__subtitle">
                                                    Número de Establecimiento:
                                                </label>
                                                <div class="kt-input-icon kt-input-icon--right">
                                                    @Html.EditorFor(model => model.RecipientEstablishment, new
                                                       {
                                                           htmlAttributes = new
                                                                       {
                                                                           @id = "establecimiento_destino",
                                                                           @class = "form-control m-b",
                                                                           @style = "width:100%",
                                                                           @placeholder = "XXX",
                                                                           @min = "000",
                                                                           @max = "999",
                                                                           @maxlength = "3",
                                                                           @tooltip = "Codigo de Establecimiento",
                                                                           @required = ""
                                                                       }
                                                                   })
                                                </div>
                                            </div>
                                           
                                        </td>
                                    </tr>
                                    <tr>                                        
                                        <td style="text-align: left; padding-bottom: 5px">
                                            <div class="col-md-12 col-sm-12 col-xs-12">
                                                <label class="kt-invoice__subtitle">
                                                    Placa del Vehículo:
                                                </label>
                                                <div class="kt-input-icon kt-input-icon--right">
                                                    @Html.EditorFor(model => model.CarPlate, new
                                                        {
                                                            htmlAttributes = new
                                                                         {
                                                                             @class = "form-control m-b",
                                                                             @style = "width:100%;",
                                                                             @maxlength = "8",
                                                                             @placeholder = "Número de Placa",
                                                                             @required = ""
                                                                         }
                                                                     })
                                                </div>
                                            </div>
                                            
                                        </td>
                                    </tr>

                                </table>
                            </div>
                            <div class="col-md-6 col-sm-10 col-xs-12">
                                <table class="border-0" style="width:100%;">
                                    <tr>                                       
                                        <td style="text-align:left;padding-bottom:5px">
                                            <div class="col-md-12 col-sm-12 col-xs-12">
                                                <label class="kt-invoice__subtitle">
                                                    Destinatario:
                                                </label>
                                                <div class="kt-input-icon kt-input-icon--right">
                                                    @Html.DropDownListFor(model => model.RecipientId, new SelectList(recipientList, "Value", "Text", Model.RecipientId), "Seleccione destinatario",
                                                                                                           new { @class = "form-control js-customerSelector", @style = "width:100%;", @data_field = "R" })
                                                    @Html.HiddenFor(model => model.RecipientIdentification, new { @id = "recipient_identificacion" })
                                                    @Html.HiddenFor(model => model.RecipientIdentificationType, new { @id = "recipient_tipoidentificacion" })
                                                    @Html.HiddenFor(model => model.RecipientName, new { @id = "recipient_name" })
                                                </div>
                                            </div>
                                           
                                        </td>
                                    </tr>
                                    <tr>                                        
                                        <td style="text-align:left;padding-bottom:5px">

                                            <div class="col-md-12 col-sm-12 col-xs-12">
                                                <label class="kt-invoice__subtitle">
                                                    Conductor:
                                                </label>
                                                <div class="kt-input-icon kt-input-icon--right">
                                                    @Html.DropDownListFor(model => model.DriverId, new SelectList(driverList, "Value", "Text", Model.DriverId), "Seleccione conductor",
                                                       new { @class = "form-control js-customerSelector", @style = "width:100%;", @data_field = "D" })

                                                    @Html.HiddenFor(model => model.DriverIdentification, new { @id = "driver_identificacion" })
                                                    @Html.HiddenFor(model => model.DriverIdentificationType, new { @id = "driver_tipoidentificacion" })
                                                    @Html.HiddenFor(model => model.DriverName, new { @id = "driver_name" })
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>                                        
                                        <td style="text-align:left; padding-bottom: 5px">
                                            <div class="col-md-12 col-sm-12 col-xs-12">
                                                <label class="kt-invoice__subtitle">
                                                    Ruta de envío:
                                                </label>
                                                <div class="kt-input-icon kt-input-icon--right">
                                                    @Html.EditorFor(model => model.ShipmentRoute, new
                                                                                               {
                                                                                                   htmlAttributes = new
                                                                                                   {
                                                                                                   @class = "form-control m-b",
                                                                                                   @style = "width:100%;",
                                                                                                   @placeholder = "Ruta",
                                                                                                   @required = ""
                                                                                               }
                                                                                               })
                                                </div>
                                            </div>
                                           

                                        </td>
                                    </tr>

                                </table>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">

                            </div>
                        </div>
                    </div>                 
                </div>

                <div class="kt-invoice__items">
                    <div class="kt-invoice__item col-md-12 col-sm-12 col-xs-12">
                        <div class="row">                           
                            <div class="col-md-12">
                                <table class="border-0" style="width:100%;">
                                    <tr> 
                                                                             
                                        <td>FECHA</td>
                                        <td>LUGAR/DIRECCIÓN</td>
                                    </tr>
                                    <tr>                                        
                                        <td style="text-align: left; padding-bottom:5px;">
                                            <div class="col-md-6 col-sm-12 col-xs-12">
                                                <label class="kt-invoice__subtitle">
                                                    PARTIDA:
                                                </label>
                                                <div class="kt-input-icon kt-input-icon--right">

                                                    @Html.EditorFor(model => model.ShippingStartDate, new
                                                       {
                                                           htmlAttributes = new
                                                           {
                                                               @id = "fecha_envio",
                                                               @class = "form-control input-readonly",
                                                               @placeholder = "Fecha Inicio",
                                                               @tooltip = "Fecha de Inicio",
                                                               @readonly = "readonly",
                                                               @style = "text-align:center;"                                                               
                                                           }
                                                       })
                                                   
                                                </div>  
                                            </div>
                                            
                                        </td>
                                        <td colspan="2" style="text-align: left; padding-bottom:5px;">
                                            <div class="col-md-12 col-sm-12 col-xs-12">
                                                <label class="kt-invoice__subtitle"></label>
                                                <div class="kt-input-icon kt-input-icon--right">
                                                    @Html.EditorFor(model => model.OriginAddress, new
                                                       {
                                                           htmlAttributes = new
                                                           {
                                                                       @class = "form-control input-readonly",
                                                                       @tooltip = "Dirección de Partida",
                                                                       @placeholder = "Dirección de Partida",
                                                                       @width = "100%"
                                                                   }
                                                       })
                                                </div>
                                            </div>
                                           
                                        </td>
                                    </tr>
                                    <tr>                                        
                                        <td style="text-align: left; padding-bottom: 5px;">
                                            <div class="col-md-6 col-sm-12 col-xs-12">
                                                <label class="kt-invoice__subtitle">
                                                    LLEGADA:
                                                </label>
                                                <div class="kt-input-icon kt-input-icon--right">
                                                    @Html.EditorFor(model => model.ShippingEndDate, new
                                                       {
                                                           htmlAttributes = new
                                                           {
                                                               @id = "fecha_llegada",
                                                               @class = "form-control input-readonly",
                                                               @placeholder = "Fecha Fin",
                                                               @tooltip = "Fecha de Llegada",
                                                               @readonly = "readonly",
                                                               @style = "text-align:center;"                                                              
                                                           }
                                                       })                                                   
                                                </div>
                                            </div>
                                           
                                        </td>
                                        <td colspan="2" style="text-align: left; padding-bottom:5px;">
                                            <div class="col-md-12 col-sm-12 col-xs-12">
                                                <label class="kt-invoice__subtitle"></label>
                                                <div class="kt-input-icon kt-input-icon--right">
                                                    @Html.EditorFor(model => model.DestinationAddress, new
                                                       {
                                                           htmlAttributes = new
                                                           {
                                                           @class = "form-control input-readonly",
                                                           @placeholder = "Dirección de Llegada",
                                                           @tooltip = "Dirección de Llegada"
                                                       }
                                                       })
                                                </div>
                                            </div>                                           
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        @* Detalle de los productos *@
        <div class="row" name="productosPage">
            <div class="col-12">
                <div class="kt-container table-responsive bg-white" style="width:auto">
                    <table class="product-items col-md-12 table table-producto table-hover table-striped table-condensed kt-datatable__table cf">
                        <thead class="cf card-title kt-datatable__head">
                            <tr class="kt-datatable__row">
                                <th>
                                    <div class="row">
                                        <div class="col-md-12 col-sm-10 col-xs-12">
                                            <div class="row">
                                                <div class="col-md-5 col-sm-12 col-xs-12" data-title="Descripcion" style="padding-bottom:5px">Descripción</div>                                                
                                                <div class="col-md-2 col-sm-6 col-xs-12" data-title="Detalles Adicional 1" style="padding-bottom:5px">Det Adicional 1</div>
                                                <div class="col-md-2 col-sm-6 col-xs-12" data-title="Detalles Adicional 2" style="padding-bottom:5px">Det Adicional 2</div>
                                                <div class="col-md-2 col-sm-6 col-xs-12" data-title="Detalles Adicional 3" style="padding-bottom:5px">Det Adicional 3</div>     
                                                <div class="col-md-1 col-sm-4 col-xs-12 text-center" data-title="Cantidad total" style="padding-bottom:5px">Cantidad Total</div>
                                            </div>
                                        </div>
                                    </div>
                                </th>
                            </tr>
                        </thead>

                        <tbody>
                            @if (Model.Details != null)
                            {
                                for (int i = 0; i < Model.Details.Count; i++)
                                {
                                    var productList = new SelectList(new[]
                                    {
                                            new SelectListItem {
                                                Text = string.Format("{0}.{1} {2}", Model.Details[i].MainCode, Model.Details[i].AuxCode, Model.Details[i].Description),
                                                Value = (Model.Details[i].ProductId ?? 0).ToString()
                                            }
                                    }, "Value", "Text", Model.Details[i].ProductId);                                    

                                    <tr id="item@(i)" class="product-item">
                                        <td data-title="Product" style="width:100%">
                                            <div class="row">
                                                <div class="col-md-12 col-sm-10 col-xs-12">
                                                    <div class="row">
                                                        @Html.Hidden("Details.Index", i)
                                                        @Html.HiddenFor(model => Model.Details[i].MainCode, new { @class = "item-maincode" })
                                                        @Html.HiddenFor(model => Model.Details[i].AuxCode, new { @class = "item-auxcode" })
                                                        @Html.HiddenFor(model => Model.Details[i].Description, new { @class = "item-description" })

                                                        <div class="col-md-5 col-sm-12" data-title="Descripcion" style="padding-bottom:5px">
                                                            @Html.DropDownListFor(model => Model.Details[i].ProductId, productList, new { @class = "form-control", @style = "width:100%;" })
                                                        </div>

                                                        <div class="col-md-2 col-sm-6 col-xs-12 input-group" data-title="Detalle1" style="padding-bottom:5px">
                                                            @Html.TextBoxFor(model => Model.Details[i].Name1, new { @id = string.Format("detname1_{0}", i), @class = "form-control item-name1", @style = "text-align:left;font-size:11px;", @placeholder = "Nombre 1" })
                                                            @Html.TextBoxFor(model => Model.Details[i].Value1, new { @id = string.Format("detval1_{0}", i), @class = "form-control item-value1", @style = "text-align:left;font-size:11px;", @placeholder = "Valor 1" })
                                                        </div>

                                                        <div class="col-md-2 col-sm-6 col-xs-12 input-group" data-title="Detalle2" style="padding-bottom:5px">
                                                            @Html.TextBoxFor(model => Model.Details[i].Name2, new { @id = string.Format("detname2_{0}", i), @class = "form-control item-name2", @style = "text-align:left;font-size:11px;", @placeholder = "Nombre 2" })
                                                            @Html.TextBoxFor(model => Model.Details[i].Value2, new { @id = string.Format("detval2_{0}", i), @class = "form-control item-value2", @style = "text-align:left;font-size:11px;", @placeholder = "Valor 2" })
                                                        </div>

                                                        <div class="col-md-2 col-sm-6 col-xs-12 input-group" data-title="Detalle3" style="padding-bottom:5px">
                                                            @Html.TextBoxFor(model => Model.Details[i].Name3, new { @id = string.Format("detname3_{0}", i), @class = "form-control item-name3", @style = "text-align:left;font-size:11px;", @placeholder = "Nombre 3" })
                                                            @Html.TextBoxFor(model => Model.Details[i].Value3, new { @id = string.Format("detval3_{0}", i), @class = "form-control item-value3", @style = "text-align:left;font-size:11px;", @placeholder = "Valor 3" })
                                                        </div>

                                                        <div class="col-md-1 col-sm-4 col-xs-12" data-title="Cantidad" style="padding-bottom:5px">
                                                            @Html.TextBoxFor(model => model.Details[i].Quantity, new { @class = "form-control item-quantity", @style = "text-align:right; ", @type = "number", @value = "1", @min = "1", @placeholder = "Cantidad" })
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td data-title="">
                                            <button title="Eliminar Registro" type="button" class="delete-item btn " style="width:auto;float:none;">
                                                <span class="la la-trash-o "></span>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            }

                        </tbody>

                        <tfoot>
                            <tr style="background-color:gainsboro">
                                <td>
                                    <div class="row">
                                        <div class="col-md-11 col-sm-8 col-xs-12" align="left">
                                            <div class="row">
                                                <div class="col-md-12 col-sm-12 col-xs-12">
                                                    <button type='button' class='add-detail btn btn-brand'> Agregar <i class='fa fa-plus'></i></button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-1 col-sm-2 col-xs-12" style="padding-bottom:5px">
                                            <div class="row">
                                                <div class="col-md-12 col-sm-12 col-xs-12 numeric text-center" data-title="Cantidad">
                                                    <h4><span id="ItemQuantity">  @(Model.Details != null ? Model.Details.Sum(x => x.Quantity): 0)</span></h4>                                                   
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td data-title="">
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

            </div>
        </div>

        <div class="row">
            <div class="col-12">

                <div class="kt-container table-responsive bg-white" style="width:auto">
                    <div class="row">
                        <div class="col-12 col-md-7 col-lg-8">
                            <div class="kt-portlet__body">

                                <div class="accordion accordion-solid accordion-toggle-plus" id="accordionAdditionals">

                                    <div class="card">
                                        <div class="card-header" id="paymentHeading">
                                            <div class="card-title collapsed" data-toggle="collapse" data-target="#paymentCollapse" aria-expanded="false" aria-controls="paymentCollapse">
                                                <i class="flaticon2-contract"></i> Motivo
                                            </div>
                                        </div>
                                        <div id="paymentCollapse" aria-labelledby="paymentHeading" data-parent="#accordionAdditionals" style="">

                                            <div class="card-body">
                                                <label class="control-label bold white text-dark" style="width:100%;text-align:left;" id="etiqueta_MOTIVO"><b>OBSERVACIONES:</b></label>
                                                <textarea name="Reason" id="Reason" placeholder="Ingrese aqui el motivo o explicación de la Guia de Remisión.!"
                                                          type="text" wrap="soft" rows="4" class="form-control"
                                                          style="width:100%;border:none none solid none;  resize:vertical" value="" required>@Model.Reason</textarea>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="card">
                                        <div class="card-header" id="infoHeading">
                                            <div class="card-title collapsed" data-toggle="collapse" data-target="#infoCollapse" aria-expanded="false" aria-controls="infoCollapse">
                                                <i class="flaticon2-layers-1"></i> Informaci&oacute;n Adicional
                                            </div>
                                        </div>
                                        <div id="infoCollapse" class="collapse" aria-labelledby="infoHeading" data-parent="#accordionAdditionals" style="">
                                            <div class="card-body">

                                                <table id="adicional-items" class="table kt-datatable__table table-adicional table-hover table-striped table-condensed cf">
                                                    <tbody>
                                                        @if (Model.AdditionalFields != null)
                                                        {
                                                            for (var i = 0; i < Model.AdditionalFields.Count; i++)
                                                            {
                                                                var fieldname = Model.AdditionalFields[i].Name?.ToUpper();
                                                                var hidden = "";
                                                                if (fieldname == "DIRECCION" || fieldname == "TELEFONO" || fieldname == "EMAIL")
                                                                {
                                                                    hidden = "hidden";
                                                                }
                                                                else if (fieldname == TextoInfoAdicionalEnum.IsGeneralRegime.GetDisplayValue().ToUpper() ||
                                                                  fieldname == TextoInfoAdicionalEnum.IsSkilledCraftsman.GetDisplayValue().ToUpper() ||
                                                                  fieldname == TextoInfoAdicionalEnum.IsSimplifiedCompaniesRegime.GetDisplayValue().ToUpper())
                                                                {
                                                                    hidden = "hidden";
                                                                }
                                                                <tr class="additional-item" @hidden>
                                                                    <td>
                                                                        @Html.Hidden("AdditionalFields.Index", i)
                                                                        @Html.HiddenFor(model => Model.AdditionalFields[i].LineNumber)
                                                                        <div class="row">
                                                                            <div data-title="Detalle" class="col-lg-6 col-md-12 col-sm-6 col-xs-12 bold" style="padding-bottom:5px">
                                                                                @Html.TextBoxFor(model => Model.AdditionalFields[i].Name, new { @id = string.Format("adname{0}", i), @class = "form-control additional-name bold", @style = "text-align:left; width:100%;", @placeholder = "Nombre", @list = "list-references" })
                                                                            </div>
                                                                            <div data-title="Valor" class="col-lg-6 col-md-12 col-sm-6 col-xs-12">
                                                                                @Html.TextBoxFor(model => Model.AdditionalFields[i].Value, new { @id = string.Format("addet{0}", i), @class = "form-control additional-value", @style = "text-align:left; ", @placeholder = "Detalle" })
                                                                            </div>
                                                                        </div>
                                                                    </td>
                                                                    <td>
                                                                        <button title="Eliminar Registro" type="button" class="delete-item btn" style="float: none;width:auto;">
                                                                            <span class="la la-trash-o"></span>
                                                                        </button>
                                                                    </td>
                                                                </tr>
                                                            }
                                                        }
                                                    </tbody>
                                                    <tfoot>
                                                        <tr>
                                                            <td align="left" colspan="3">
                                                                <div class="row">
                                                                    <div class="col-12" align="left">
                                                                        <button type='button' class='btn btn-brand add-additional'> Agregar <i class='fa fa-plus'></i></button>
                                                                    </div>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    </tfoot>
                                                </table>

                                                <datalist id="list-references">

                                                    <option>ORDEN DE COMPRA</option>
                                                    <option>REFERENCIA</option>
                                                    <option>VENDEDOR</option>
                                                    <option>CONTACTO</option>
                                                    <option>CHOFER</option>
                                                    <option>ENTREGADO POR</option>
                                                    <option>SOLICITANTE</option>
                                                    <option>RECIBIDO POR</option>
                                                    <option>UBICACION</option>
                                                    <option>DESTINO</option>
                                                    <option>DESTINATARIO</option>
                                                    <option>DEDUCIBLE</option>

                                                </datalist>


                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row col-12">
                                    @Html.ValidationSummary("", new { @class = "text-danger" })
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-5 col-lg-4">
                            <div class="kt-invoice__total align-content-center align-items-center justify-content-center align-self-center">
                                <table class="table table-advance table-hover table-scrollable-borderless table-total">
                                    <tbody>
                                       <tr style="border-top:3px;border-top-style:double; margin-bottom:30px;">
                                            <td class="bold bg"><h4 class="control-label kt-font-bold" id="etiqueta_total">CANTIDAD TOTAL</h4></td>
                                            <td></td>
                                            <td class="bold text-right">
                                                <h4 data-field="Total">$ @Model.Total.ToDecimalString()</h4>
                                                @Html.HiddenFor(model => model.Total, new { @class = "invoice-subtotal" })
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>


                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>


}

@section scripts{
    @Scripts.Render("~/js/referralguide")

<script>
    $(document).ready(function () {
        ReferralGuide.documentUrl = '@Url.Content("~/GuiaRemision/SearchDocumentsAsync")';
        ReferralGuide.documentbyIdUrl = '@Url.Content("~/GuiaRemision/GetDocumentById")';
        ReferralGuide.contributorsUrl = '@Url.Content("~/contribuyentes/searchcontribAsync")';
        ReferralGuide.productsUrl = '@Url.Content("~/producto/searchproductAsync")';
        ReferralGuide.loginUrl = '@Url.Content("~/auth")';
        ReferralGuide.establishments = @Html.Raw(Json.Encode(SessionInfo.Issuer.Establishments));       
        ReferralGuide.init();
    });
</script>
}

@section Toolbar{


    <div class="btn-group">

        <button type="button" class="btn btn-brand btn-invoice-save">
            <i class="la la-check"></i>
            <span class="kt-hidden-mobile">Guardar</span>
        </button>

        <button type="button" class="btn btn-brand dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        </button>

        <div class="dropdown-menu dropdown-menu-right" x-placement="bottom-end" style="position: absolute; will-change: transform; top: 0px; left: 0px; transform: translate3d(-58px, 38px, 0px);">
            <ul class="kt-nav">
                <li class="kt-nav__item">
                    <a href="#" class="kt-nav__link btn-invoice-save" id="btnGuardar">
                        <i class="kt-nav__link-icon flaticon2-shield"></i>
                        <span class="kt-nav__link-text">Guardar borrador</span>
                    </a>
                </li>
                <li class="kt-nav__item">
                    <a href="#" class="kt-nav__link btn-invoice-issue">
                        <i class="kt-nav__link-icon flaticon2-paper-plane"></i>
                        <span class="kt-nav__link-text">Enviar al SRI</span>
                    </a>
                </li>
            </ul>
        </div>

    </div>




}



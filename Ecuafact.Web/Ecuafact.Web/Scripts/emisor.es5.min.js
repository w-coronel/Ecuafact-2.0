"use strict";var Emisor=function(){$('[data-toggle="tooltip"]').tooltip();var o,s,fi=KTUtil.get("kt_wizard_v2"),u=$("#issuer_form"),ei=$("#RUC"),oi=new KTAvatar("logo"),b=$("#IsAccountingRequired"),n=$("#IsSpecialContributor"),t=$("#ResolutionNumber"),st=$("#establishment_Code"),ht=$(".item-Establishment-Code"),ct=$(".item-IssuePoint-Code"),k=$("#IsRetentionAgent"),a=$("#IsRimpe"),v=$("#IsPopularBusiness"),i=$("#AgentResolutionNumber"),si=$("#MicroBusiness"),lt=$(".add-issuePoint"),at=$(".add-detail"),d=$("#IsSkilledCraftsman"),r=$("#SkilledCraftsmanNumber"),y=!1,f=!1,h=0,c=0,e=function(){if(!y){y=!0;var t=$(this),n=t.val();n.length>0&&n.length<3&&(n=n.padStart(3,"0"),t.val(n));y=!1}},vt=function(n){if(!u.validate())return n.preventDefault(),toastr.warning("Debe completar la informacion requerida!"),!1},g=function(){var t=b.val();n.val(!1);isTrue(t)?(n.removeAttr("readonly"),n.removeAttr("disabled"),n.removeClass("readonly"),n.removeClass("disabled")):(n.attr("readonly","readonly"),n.attr("disabled","disabled"),n.addClass("readonly"),n.addClass("disabled"));nt()},nt=function(){var i=n.val();isTrue(i)?(t.removeAttr("readonly"),t.removeAttr("disabled"),t.removeClass("readonly"),t.removeClass("disabled")):(t.val(""),t.attr("readonly","readonly"),t.attr("disabled","disabled"),t.addClass("readonly"),t.addClass("disabled"))},yt=function(){var n=v.val();isTrue(n)&&(a[0].checked=!1)},pt=function(){var n=a.val();isTrue(n)&&(v[0].checked=!1)},wt=function(){var n=k.val();isTrue(n)?(i.removeAttr("readonly"),i.removeAttr("disabled"),i.removeClass("readonly"),i.removeClass("disabled")):(i.val(""),i.attr("readonly","readonly"),i.attr("disabled","disabled"),i.addClass("readonly"),i.addClass("disabled"))},tt=function(){var n=d.val();isTrue(n)?(r.removeAttr("readonly"),r.removeAttr("disabled"),r.removeClass("readonly"),r.removeClass("disabled")):(r.val(""),r.attr("readonly","readonly"),r.attr("disabled","disabled"),r.addClass("readonly"),r.addClass("disabled"))},bt=function(){$("#CertificateFile").on("change",ut);$("#CertificatePass").on("change",ut)},kt=function(){var s=$(this),i,r;if(c==0&&(c=$("tr.establishment-item").length-1),i=$("tr.establishment-item").length+1,i>5){Swal.fire("Establecimientos","Se permiti un maximo la configuraci&oacute;n de 5 establecimientos!","warning");return}c++;var n=c,t=0,u='<tr id="est_item'+n+'" class="establishment-item"><td data-title="Product" style="width:100%"><div class="row"><input id = "estab_Index'+n+'"  name = "Establishments.Index" value = "'+n+'" type = "hidden" ><\/input><div class="col-md-3 col-sm-12 col-xs-12" data-title="Codigo" title="C&oacute;digo establecimiento" style="padding-bottom:5px"><div class="kt-input-icon kt-input-icon--right"><span class="kt-input-icon__icon kt-input-icon__icon--right"><span><i class="flaticon-home-2"><\/i><\/span><\/span><input id="estab_code'+n+'" name="Establishments['+n+'].Code"  class="form-control placeholder-no-fix item-Establishment-Code" type = "number" min = "1" max = "999" minlength = "3" maxlength = "3" placeholder = "Establecimiento" required data-msg = "C&oacute;digo del establecimiento es requerido" /><span class="field-validation-valid text-danger" data-valmsg-for="Establishments['+t+'].Code" data-valmsg-replace="true"><\/span><\/div><\/div><div class="col-md-4 col-sm-12 col-xs-12" data-title="Nombre" style="padding-bottom:5px"><div class="col-12 kt-input-icon kt-input-icon--right"><span class="kt-input-icon__icon kt-input-icon__icon--right"><span><i class="flaticon-profile"><\/i><\/span><\/span><input id="estab_name'+n+'" name="Establishments['+n+'].Name" title="Nombre Comercial Establecimiento"  class="form-control item-Establishment-Name"  placeholder = "Nombre comercial" required data-msg = "Nombre comercial del establecimiento es requerido" /><span class="field-validation-valid text-danger" data-valmsg-for="Establishments['+n+'].Name" data-valmsg-replace="true"><\/span><\/div><\/div><div class="col-md-5 col-sm-12 col-xs-12" data-title="Direccion" style="padding-bottom:5px"><div class="kt-input-icon kt-input-icon--right"><span class="kt-input-icon__icon kt-input-icon__icon--right"><span><i class="flaticon-placeholder-3"><\/i><\/span><\/span><input id="estab_address'+n+'" name="Establishments['+n+'].Address" title="Direcci&oacute;n Comercial Establecimiento"  class="form-control item-Establishment-address" placeholder = "Direcci&oacute;n" required data-msg = "La direcci&oacute;n del establecimiento es requerido"/><span class="field-validation-valid text-danger" data-valmsg-for="Establishments['+n+'].Address" data-valmsg-replace="true"><\/span><\/div><\/div><div class="col-md-12 col-sm-12 col-xs-12"><div class="accordion accordion-solid accordion-toggle-plus" id="accordIssuePointItem'+n+'"><div class="card"><div class="card-header" id="itemHeading'+n+'"><div class="card-title collapsed" data-toggle="collapse" data-target="#itemsCollapse'+n+'" aria-expanded="false" aria-controls="itemsCollapse'+n+')"><br /><i class="flaticon2-add"><\/i>  Configuraci&oacute;n Puntos de Emisi&oacute;n <\/div><\/div><div id="itemsCollapse'+n+'" class="collapse" aria-labelledby="itemHeading'+n+'" data-parent="#accordIssuePointItem'+n+'" style=""><div class="card-body"><table id="issuePoint-items'+n+'" data-content="'+n+'" class="table kt-datatable__table table-adicional table-hover table-striped table-condensed cf"><thead class="cf card-title kt-datatable__head"><tr class="kt-datatable__row"><th><div class="row"><div class="col-md-6 col-sm-8 col-xs-10" data-title="Codigo" style="padding-bottom:5px">C&oacute;digo<\/div><div class="col-md-2 col-sm-2 col-xs-2" data-title="Eliminar" style="padding-bottom:5px"><\/div><\/div><\/th><\/tr><\/thead><tbody><tr id="issuePoint-item'+n+'" class="product-item'+n+'"><td><div class="row"><input id = "issuePoint_Index'+n+"_"+t+'"  name = "IssuePoint.Index" value = "'+n+'" type = "hidden" ><\/input><div class="col-md-6 col-sm-8 col-xs-10" data-title="Codigo" style="padding-bottom:5px"><div class="kt-input-icon kt-input-icon--right"><span class="kt-input-icon__icon kt-input-icon__icon--right"><span><i class="flaticon-map"><\/i><\/span><\/span><input id="code_'+n+"_"+t+'" name="Establishments['+n+"].IssuePoint["+t+'].Code" data-field="'+n+'"  class="form-control placeholder-no-fix item-IssuePoint-Code", type = "number" min = "1" max = "999" minlength = "3" maxlength = "3" placeholder = "Punto emisi&oacute;n"  required data-msg = "El punto de emisi&oacute;n es requerido" /><span class="field-validation-valid text-danger" data-valmsg-for="Establishments['+n+"].IssuePoint["+t+'].Code" data-valmsg-replace="true"><\/span><\/div><\/div><div class="col-md-2 col-sm-2 col-xs-2" data-title="Eliminar" style="padding-bottom:5px"><button id="add_trash_'+n+"_"+t+'" title="Eliminar Punto emisi&oacute;n" type="button" class="delete-item btn" data-field="issuePoint-items'+n+'" style="width:auto;float:none;"><span class="la la-trash-o "><\/span><\/button><\/div><\/div><\/td><td data-title=""><\/td><\/tr><\/tbody><tfoot><tr><td align="left" colspan="2"><div class="row"><div class="col-md-12 col-sm-12 col-xs-12" align="left"><button type="button" id = "add-issuePoint_'+n+"_"+t+'" data-field="issuePoint-items'+n+'" title="Agregar puntos de emisi&oacute;n" class="btn btn-brand add-issuePoint btn-sm"><i class="fa fa-plus"><\/i> P. Emisi&oacute;n<\/button><\/div><\/div><\/td><\/tr><\/tfoot><\/table><\/div><\/div><\/div><\/div><\/div><\/div><\/td><td data-title=""><button id="estab_add_trash'+n+'" title="Eliminar Registro" type="button" class="delete-item btn " style="width:auto;float:none;"><span class="la la-trash-o"><\/span><\/button><\/td><\/tr>',h=$(".product-items").append(u),o=$("#estab_code"+n);$("#estab_add_trash"+n).on("click",rt);$("#estab_code"+n).on("change",e);typeof f!="undefined"&&f&&o.focus();$("#add-issuePoint_"+n+"_"+t).on("click",it);r=$("#code_"+n+"_"+t);$("#add_trash_"+n+"_"+t).on("click",p);$("#code_"+n+"_"+t).on("change",e);typeof f!="undefined"&&f&&r.focus()},it=function(){var o=$(this),i=o[0].dataset.field,s=$("#"+i),n=parseInt(s[0].dataset.content),r,u;if(h==0&&(h=$("tr.product-item"+n).length-1),r=$("tr.product-item"+n).length+1,Emisor.validateIssuePoint&&Emisor.amountIssuePoints>0){if(Emisor.issuePoints>=Emisor.amountIssuePoints){u="La cantidad de puntos de emisi&oacute;n del plan adquirido, ha llegado al l&iacute;mite de "+Emisor.amountIssuePoints+" puntos de emisi&oacute;n !";Swal.fire("Punto de emisi&oacute;n",u,"warning");return}Emisor.issuePoints++}else if(r>10){Swal.fire("Punto de emisi&oacute;n","Se permite un m&aacute;ximo la configuraci&oacute;n de 10 puntos de emisi&oacute;n!","warning");return}h++;var t=h,c='<tr id="issuePoint-item'+n+"_"+t+'" class="product-item'+n+'"><td><div class="row"><input id = "item'+n+"_"+t+'"  name = "IssuePoint.Index" value = "'+t+'" type = "hidden" ><\/input><div class="col-md-6 col-sm-8 col-xs-10" data-title="Codigo" style="padding-bottom:5px"><div class="kt-input-icon kt-input-icon--right"><span class="kt-input-icon__icon kt-input-icon__icon--right"><span><i class="flaticon-map"><\/i><\/span><\/span><input id="code_'+n+"_"+t+'" name="Establishments['+n+"].IssuePoint["+t+'].Code" data-field="'+n+'"  class="form-control placeholder-no-fix item-IssuePoint-Code" type = "number"  min = "1" max = "999" minlength = "3" maxlength = "3" placeholder = "Punto emisi&oacute;n" required data-msg = "El punto de emisi�n es requerido"/><span class="field-validation-valid text-danger" data-valmsg-for="Establishments['+n+"].IssuePoint["+t+'].Code" data-valmsg-replace="true"><\/span><\/div><\/div><div class="col-md-2 col-sm-4 col-xs-6" data-title="Nombre" style="padding-bottom:5px"><button id="add_trash_'+n+"_"+t+'" title="Eliminar Punto emisi&oacute;n" type="button"  class="delete-item btn " style="width:auto;float:none;"><span class="la la-trash-o "><\/span><\/button><\/div><\/div><\/td><td data-title=""><\/td><\/tr>',a=$("#"+i).append(c),l=$("#code_"+n+"_"+t);$("#add_trash_"+n+"_"+t).on("click",p);$("#code_"+n+"_"+t).on("change",e);typeof f!="undefined"&&f&&l.focus()},p=function(){var n=$(this);if(n[0].parentElement.parentElement.parentElement.parentElement.parentElement.childElementCount==1){Swal.fire("Punto de emisi&oacute;n","Se requiere al menos un item en la lista!","warning");return}n[0].parentElement.parentElement.parentElement.parentElement.remove();Emisor.validateIssuePoint&&Emisor.amountIssuePoints>0&&Emisor.issuePoints--},rt=function(){var n=$(this);if(n[0].parentElement.parentElement.parentElement.childElementCount==1){Swal.fire("Establecimiento","Se requiere al menos un item en la lista!","warning");return}n[0].parentElement.parentElement.remove()},ut=function(){var n;if(Emisor.urlCertValidator){$("#CertificateExpirationDate").val("");$("#CertificateIssuedTo").val("");$("#CertificateSubject").val("");$("#CertificateSubject").removeClass("text-danger");$("#CertificateUsage").val("");$("#CertificateRUC").val("");var r=document.getElementById("configForm"),t=$("#CertificatePass").val(),i=$("#CertificateFile")[0].files[0];i&&t&&(n=new FormData,n.append("CertificatePass",t),n.append("CertificateRaw",i),$.ajax({url:Emisor.urlCertValidator,type:"POST",data:n,success:function(n){if(n&&n.Entity)n.Entity.ExpirationDate&&$("#CertificateExpirationDate").val(n.Entity.ExpirationDate),n.Entity.FriendlyName&&$("#CertificateIssuedTo").val(n.Entity.FriendlyName),n.Entity.Subject&&$("#CertificateSubject").val(n.Entity.Subject),n.Entity.CertificateRUC&&$("#CertificateRUC").val(n.Entity.CertificateRUC),n.Entity.KeyUsages&&$("#CertificateUsage").val(n.Entity.KeyUsages);else if(console.log(n),typeof n=="string"&&n.includes("kt-login"))toastr.error("Su sesi�n ha caducado... por favor vuelva a iniciar sesi�n!"),window.open(location.href,"_blank");else{var t="Hubo un error al cargar la firma, la clave o el archivo especificado no son correctos!";$("#CertificateSubject").addClass("text-danger");$("#CertificateSubject").val(t);toastr.danger(t)}},error:function(n){console.log(n);var t="Hubo un error al cargar la firma, la clave o el archivo especificado no son correctos!";$("#CertificateSubject").addClass("text-danger");$("#CertificateSubject").val(t);toastr.error(t)},cache:!1,contentType:!1,processData:!1}))}},ft=function(){b.on("change keyup click",g);n.on("change keyup click",nt);u.on("submit",vt);st.on("change",e);ht.on("change",e);ct.on("change",e);k.on("change keyup click",wt);a.on("change keyup click",pt);v.on("change keyup click",yt);d.on("change keyup click",tt);lt.on("click",it);at.on("click",kt);$(".delete-item").on("click",p);$(".estab-delete-item").on("click",rt);g();tt()},et=function(){s=new KTWizard("kt_wizard_v2",{startStep:1,clickableSteps:!0});s.on("beforeNext",function(n){l();o.form()!==!0&&n.stop()});s.on("beforePrev",function(n){l();o.form()!==!0&&n.stop()});s.on("change",function(){KTUtil.scrollTop()})},dt=function(){var n=!($("#Id").val()>0),t=n?{required:!0,minlength:13,maxlength:13,digits:!0}:{required:!0,digits:!0};o=u.validate({ignore:":hidden",rules:{Id:{required:!0},RUC:t,TradeName:{required:!0},BussinesName:{required:!0},Email:{required:!0},EstablishmentAddress:{required:!0},MainAddress:{required:!0},Phone:{required:!0}},invalidHandler:function(n,t){KTUtil.scrollTop();swal.fire({title:"",text:gt(t),type:"error",confirmButtonClass:"btn btn-secondary"})},submitHandler:function(){showLoader();w()}})},gt=function(n){var i="Hay algunos errores en los datos ingresados. Por favor corregirlos antes de continuar. ",t;if(n&&n.errorList.length>0)for(t=0;t<n.errorList.length;++t)n.errorList[t].message.includes("Este campo es obligatorio.")||(i+=n.errorList[t].message+", ");return i.substr(0,i.length-2)},ot=function(){var t=Emisor.user,n=$("#RUC").val();n&&n.includes(t)||t&&t.includes(n)?($("#sri_password").hide(),$("#SRIPassword").val(n)):($("#sri_password").show(),$("input#SRIPassword").val(""),$("input#SRIPassword").focus())},ni=function(){$("#RUC").on("change",ot);o=u.validate({ignore:":hidden",rules:{RUC:{required:!0,minlength:13,maxlength:13,digits:!0},SRIPassword:{required:!0}},invalidHandler:function(){KTUtil.scrollTop();swal.fire({title:"",text:"Hay algunos errores en los datos ingresados. Por favor corregirlos antes de continuar.",type:"error",confirmButtonClass:"btn btn-secondary"})},submitHandler:function(n){ui(n)}});ot()},ti=function(){$(".firma-button").on("click",function(){$(".certificate").val(1);l();w()});$(".save-button").on("click",function(){l();w()});$(".solicitud-esign").on("click",function(){var n=$(this);ii(n)})},ii=function(n){var t=n,r=parseInt(t.data("options").option),i=t.data("options").valor;switch(r){case 1:Swal.fire("Informaci&oacute;n",i,"info");event.preventDefault();break;case 2:Swal.fire("Informaci&oacute;n",i,"info");t.data("options",{option:3,valor:Emisor.urlPlans});t[0].innerText="SOLICITAR PLAN";event.preventDefault();break;default:event.preventDefault();showLoader();location.assign(i)}},ri=function(){for(var h,e,n,s=$("tr.establishment-item"),o=0;o<s.length;o++)for(h=$(s[o]),e=h.find(".item-IssuePoint-Code"),n=0;n<e.length;n++){var r=parseInt(e[n].dataset.field),f=e[n].id.replace(/Establishments_|__IssuePoint|__Code/g,"").split("_"),t=0,i=0;f.length==2?(t=parseInt(f[0]),i=parseInt(f[1])):f.length==3&&(t=parseInt(f[1]),i=parseInt(f[2]));var c=$("#Establishments_"+t+"__IssuePoint_"+i+"__Name"),l=$("#Establishments_"+t+"__IssuePoint_"+i+"__CarrierRUC"),a=$("#Establishments_"+t+"__IssuePoint_"+i+"__CarrierPhone"),v=$("#Establishments_"+t+"__IssuePoint_"+i+"__CarrierEmail"),y=$("#Establishments_"+t+"__IssuePoint_"+i+"__CarPlate");e[n].name="Establishments["+r+"].IssuePoint["+n+"].Code";c.length>0&&(c[0].name="Establishments["+r+"].IssuePoint["+n+"].Name");l.length>0&&(l[0].name="Establishments["+r+"].IssuePoint["+n+"].CarrierRUC");a.length>0&&(a[0].name="Establishments["+r+"].IssuePoint["+n+"].CarrierPhone");v.length>0&&(v[0].name="Establishments["+r+"].IssuePoint["+n+"].CarrierEmail");y.length>0&&(y[0].name="Establishments["+r+"].IssuePoint["+n+"].CarPlate")}return new FormData(u[0])},l=function(){for(var u,t,n,f,e,r=$("tr.establishment-item"),i=0;i<r.length;i++)for(u=$(r[i]),t=u.find(".item-IssuePoint-Code"),n=0;n<t.length;n++)if(f=parseInt(t[n].dataset.field),t[n].value==""){e=$("#itemsCollapse"+f);e.collapse("show");return}},ui=function(n){Swal.fire({title:"Vincular Emisor",text:"Desea continuar con el proceso? ",icon:"info",type:"warning",showCancelButton:!0,cancelButtonText:"Cancelar",confirmButtonText:"Aceptar"}).then(function(t){t.value&&(showLoader(),n.submit())})},w=function(){var t=u.attr("action"),n;o.form()&&u.valid()&&(n=ri(),showLoader(),$.ajax({url:t,type:"POST",data:n,success:function(n){n&&n.id>0?(toastr.success(n.statusText),location.assign(n.url)):typeof n=="string"&&n.includes("kt-login")?(toastr.error("Su sesi�n ha caducado... por favor vuelva a iniciar sesi�n!"),window.open(n.url,"_blank")):n.error?toastr.warning(n.error.DevMessage||"",n.error.UserMessage||n.statusText):toastr.warning(n.statusText);hideLoader()},error:function(){toastr.error("Hubo un error al guardar el emisor!");hideLoader()},cache:!1,contentType:!1,processData:!1}))};return{user:"",validateIssuePoint:!1,amountIssuePoints:0,issuePoints:0,urlRUCValidator:"",urlConfiguration:"",urlCertValidator:"",urlPlans:"",init:function(){ft();et();bt();dt();ti()},"new":function(){ft();et();ni()}}}();